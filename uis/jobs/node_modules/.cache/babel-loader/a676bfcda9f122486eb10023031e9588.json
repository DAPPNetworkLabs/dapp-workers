{"ast":null,"code":"import Web3 from 'web3';\nimport NexusJSON from '../../abi/Nexus.json';\nconst jobs = [];\nconst services = [];\nconst provider = new Web3.providers.WebsocketProvider('ws://localhost:8545');\nconst web3 = new Web3(provider);\nconst contractAddress = \"0x94D387F50569200aDACFd903345D077ef6ABcE11\";\nconst contract = new web3.eth.Contract(NexusJSON.abi, contractAddress);\nconst ethereum = window.ethereum;\n\nconst returnAbi = func => {\n  return NexusJSON.abi.find(el => el.name == func && el.type == \"function\");\n};\n\nconst fetchContractEvent = (eventName, thisObject) => {\n  contract.once(eventName, function (error, event) {\n    thisObject.setState({\n      events: thisObject.state.events.push({\n        eventName,\n        event,\n        error\n      })\n    });\n  }); // await contract.events[event]({}, function(error, event){\n  //     console.log(event)\n  //     console.log(error)\n  //     return { event, error };\n  // });\n  // await contract.events[event]({}, { fromBlock: 0, toBlock: 'latest' }).on(\n  //     'data', function(event) {\n  //     console.log(event);\n  // }).on('error', console.error);\n};\n\nconst fetchLastJob = async () => {\n  return await contract.methods.lastJobID().call();\n};\n\nconst fetchJobs = async thisObject => {\n  for (let i = 0; i < (await fetchLastJob()); i++) {\n    const job = await contract.methods.jobs(i).call();\n    jobs.push(job);\n  }\n\n  thisObject.setState({\n    jobs: JSON.stringify(jobs)\n  });\n};\n\nconst fetchDspInfo = async dsp => {\n  console.log(await contract.methods.registeredDSPs(dsp).call()); // return await contract.methods.registeredDSPs(dsp).call();\n};\n\nconst fetchServices = async thisObject => {\n  for (let i = 0; i < (await fetchLastJob()); i++) {\n    const job = await contract.methods.services(i).call();\n    services.push(job);\n  }\n\n  thisObject.setState({\n    services: JSON.stringify(services)\n  });\n};\n\nconst postJobOrService = async (form, thisObject) => {\n  const abi = returnAbi(\"run\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.consumer, form.imageName, form.inputFS, form.args]);\n  await runTrx(data, [\"Run\"], thisObject);\n};\n\nconst runJob = async (form, thisObject) => {\n  const abi = returnAbi(\"jobCallback\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.jobId, form.outputFS, form.dapps]);\n  await runTrx(data, [\"JobResult\", \"JobDone\"], thisObject);\n};\n\nconst runService = async (form, thisObject) => {\n  const abi = returnAbi(\"serviceCallback\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.jobId, form.port, form.serviceDapps]);\n  await runTrx(data, [\"ServiceRunning\"], thisObject);\n};\n\nconst setDockerImage = async (form, thisObject) => {\n  const abi = returnAbi(\"setDockerImage\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.imageName, form.imageAddress, form.imageHash, form.imageType]);\n  await runTrx(data, [\"DockerSet\"], thisObject);\n};\n\nconst approveDockerImage = async (form, thisObject) => {\n  const abi = returnAbi(\"approveDockerForDSP\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.imageName]);\n  await runTrx(data, [\"DockerApprovalChanged\"], thisObject);\n};\n/*\n     getDSPEndpoint\n    getPortForDSP\n    unapproveDockerForDSP\n    isImageApprovedForDSP\n    getDockerImage\n    deprecateDSP\n    regDSP\n    claimFor\n    sellGas\n    buyGasFor\n    setConsumerCallback\n    setConsumerPermissions\n    setQuorum\n    jobError\n    serviceError\n */\n\n\nconst runTrx = async (data, events, thisObject) => {\n  const trxInfo = {\n    trxHash: null,\n    error: '',\n    events: []\n  };\n  const transactionParameters = {\n    nonce: '0x00',\n    gasPrice: '2000000000',\n    gasLimit: '21000',\n    to: contractAddress,\n    from: ethereum.selectedAddress,\n    value: '0x00',\n    data,\n    chainId: '0x3' // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.\n\n  };\n\n  if (events.length) {\n    for (const name of events) {\n      const eventInfo = fetchContractEvent(name, thisObject);\n      console.log(eventInfo);\n      trxInfo.events.push({\n        name,\n        ...eventInfo\n      });\n    }\n  }\n\n  await ethereum.request({\n    method: 'eth_sendTransaction',\n    params: [transactionParameters]\n  }).then(result => {\n    trxInfo.trxHash = result;\n  }).catch(error => {\n    trxInfo.error = error;\n  });\n  thisObject.setState({\n    trxInfo\n  });\n};\n\nexport default {\n  fetchJobs,\n  fetchServices,\n  fetchDspInfo,\n  postJobOrService,\n  runJob,\n  runService,\n  setDockerImage,\n  approveDockerImage\n};","map":{"version":3,"sources":["/Users/natanaelprudhomme/Workspaces/dapp-workers/uis/jobs/src/lib/web3/index.js"],"names":["Web3","NexusJSON","jobs","services","provider","providers","WebsocketProvider","web3","contractAddress","contract","eth","Contract","abi","ethereum","window","returnAbi","func","find","el","name","type","fetchContractEvent","eventName","thisObject","once","error","event","setState","events","state","push","fetchLastJob","methods","lastJobID","call","fetchJobs","i","job","JSON","stringify","fetchDspInfo","dsp","console","log","registeredDSPs","fetchServices","postJobOrService","form","data","encodeFunctionCall","consumer","imageName","inputFS","args","runTrx","runJob","jobId","outputFS","dapps","runService","port","serviceDapps","setDockerImage","imageAddress","imageHash","imageType","approveDockerImage","trxInfo","trxHash","transactionParameters","nonce","gasPrice","gasLimit","to","from","selectedAddress","value","chainId","length","eventInfo","request","method","params","then","result","catch"],"mappings":"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","sourcesContent":["import Web3 from 'web3';\nimport NexusJSON from '../../abi/Nexus.json';\n\nconst jobs = [];\nconst services = [];\nconst provider = new Web3.providers.WebsocketProvider('ws://localhost:8545');\nconst web3 = new Web3(provider);\nconst contractAddress = \"0x94D387F50569200aDACFd903345D077ef6ABcE11\";\nconst contract = new web3.eth.Contract(NexusJSON.abi,contractAddress);\nconst ethereum = window.ethereum;\n\nconst returnAbi = (func) => {\n    return NexusJSON.abi.find(el => el.name == func && el.type == \"function\");\n}\n\nconst fetchContractEvent = (eventName,thisObject) => {\n    contract.once(eventName, function(error, event){\n        thisObject.setState({events: thisObject.state.events.push({ eventName, event, error })})\n    });\n    // await contract.events[event]({}, function(error, event){\n    //     console.log(event)\n    //     console.log(error)\n    //     return { event, error };\n    // });\n    // await contract.events[event]({}, { fromBlock: 0, toBlock: 'latest' }).on(\n    //     'data', function(event) {\n    //     console.log(event);\n    // }).on('error', console.error);\n}\n\nconst fetchLastJob = async () => {\n    return await contract.methods.lastJobID().call();\n}\n\nconst fetchJobs = async (thisObject) => {\n    for(let i=0; i < await fetchLastJob(); i++) {\n        const job = await contract.methods.jobs(i).call();\n        jobs.push(job);\n    }\n    thisObject.setState({jobs: JSON.stringify(jobs)});\n}\n\nconst fetchDspInfo = async (dsp) => {\n    console.log(await contract.methods.registeredDSPs(dsp).call());\n    // return await contract.methods.registeredDSPs(dsp).call();\n}\n\nconst fetchServices = async (thisObject) => {\n    for(let i=0; i < await fetchLastJob(); i++) {\n        const job = await contract.methods.services(i).call();\n        services.push(job);\n    }\n    thisObject.setState({services: JSON.stringify(services)});\n}\n\nconst postJobOrService = async (form,thisObject) => {\n    const abi = returnAbi(\"run\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.consumer,\n        form.imageName,\n        form.inputFS,\n        form.args\n    ]);\n    await runTrx(data,[\"Run\"],thisObject);\n}\n\nconst runJob = async (form,thisObject) => {\n    const abi = returnAbi(\"jobCallback\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.jobId,\n        form.outputFS,\n        form.dapps\n    ]);\n    await runTrx(data,[\"JobResult\",\"JobDone\"],thisObject);\n}\n\nconst runService = async (form,thisObject) => {\n    const abi = returnAbi(\"serviceCallback\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.jobId,\n        form.port,\n        form.serviceDapps\n    ]);\n    await runTrx(data,[\"ServiceRunning\"],thisObject);\n}\n\nconst setDockerImage = async (form,thisObject) => {\n    const abi = returnAbi(\"setDockerImage\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.imageName,\n        form.imageAddress,\n        form.imageHash,\n        form.imageType\n    ]);\n    await runTrx(data,[\"DockerSet\"],thisObject);\n}\n\nconst approveDockerImage = async (form,thisObject) => {\n    const abi = returnAbi(\"approveDockerForDSP\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.imageName\n    ]);\n    await runTrx(data,[\"DockerApprovalChanged\"],thisObject);\n}\n\n    /*\n\n        getDSPEndpoint\n        getPortForDSP\n        unapproveDockerForDSP\n        isImageApprovedForDSP\n        getDockerImage\n        deprecateDSP\n        regDSP\n        claimFor\n        sellGas\n        buyGasFor\n        setConsumerCallback\n        setConsumerPermissions\n        setQuorum\n        jobError\n        serviceError\n\n    */\n\nconst runTrx = async (data,events,thisObject) => {\n    const trxInfo = {\n        trxHash: null,\n        error: '',\n        events: []\n    };\n    const transactionParameters = {\n        nonce: '0x00',\n        gasPrice: '2000000000',\n        gasLimit: '21000',\n        to: contractAddress,\n        from: ethereum.selectedAddress,\n        value: '0x00',\n        data,\n        chainId: '0x3', // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.\n    };\n    if(events.length) {\n        for(const name of events) {\n            const eventInfo = fetchContractEvent(name,thisObject);\n            console.log(eventInfo);\n            trxInfo.events.push({name, ...eventInfo});\n        }\n    }\n    await ethereum.request({\n        method: 'eth_sendTransaction',\n        params: [transactionParameters],\n    })\n    .then((result) => {\n        trxInfo.trxHash = result;\n    })\n    .catch((error) => {\n        trxInfo.error = error;\n    });\n    thisObject.setState({trxInfo});\n}\n\nexport default { \n    fetchJobs,\n    fetchServices,\n    fetchDspInfo,\n    postJobOrService,\n    runJob,\n    runService,\n    setDockerImage,\n    approveDockerImage\n}"]},"metadata":{},"sourceType":"module"}