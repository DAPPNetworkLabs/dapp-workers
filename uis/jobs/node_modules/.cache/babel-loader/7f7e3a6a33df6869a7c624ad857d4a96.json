{"ast":null,"code":"import Web3 from 'web3';\nimport NexusJSON from '../../abi/Nexus.json';\nconst jobs = [];\nconst services = []; // const provider = new Web3.providers.WebsocketProvider('ws://localhost:8545');\n// const web3 = new Web3(provider);\n\nconst web3 = new Web3('http://localhost:8545');\nconst contractAddress = \"0x94D387F50569200aDACFd903345D077ef6ABcE11\";\nconst contract = new web3.eth.Contract(NexusJSON.abi, contractAddress);\nconst ethereum = window.ethereum;\n\nconst returnAbi = func => {\n  return NexusJSON.abi.find(el => el.name == func && el.type == \"function\");\n};\n\nconst fetchLastJob = async () => {\n  return await contract.methods.lastJobID().call();\n};\n\nconst fetchJobs = async thisObject => {\n  for (let i = 0; i < (await fetchLastJob()); i++) {\n    const job = await contract.methods.jobs(i).call();\n    jobs.push(job);\n  }\n\n  thisObject.setState({\n    jobs: JSON.stringify(jobs)\n  });\n};\n\nconst fetchServices = async thisObject => {\n  for (let i = 0; i < (await fetchLastJob()); i++) {\n    const job = await contract.methods.services(i).call();\n    services.push(job);\n  }\n\n  console.log(`services: ${services}`);\n  thisObject.setState({\n    services: JSON.stringify(services)\n  });\n};\n\nconst postJobOrService = async form => {\n  const abi = returnAbi(\"run\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.consumer, form.imageName, form.inputFS, form.args]);\n  const txHash = await runTrx(data); // await contract.events.Run({}, function(error, event){\n  //     console.log(error);\n  //     console.log(event);\n  // });\n};\n\nconst runJob = async form => {\n  const abi = returnAbi(\"jobCallback\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.jobID, form.outputFS, form.dapps]);\n  const txHash = await runTrx(data);\n  await contract.events.JobResult({}, function (error, event) {\n    console.log(error);\n    console.log(event);\n  }); // await contract.events.JobDone({}, function(error, event){\n  //     console.log(error);\n  //     console.log(event);\n  // });\n};\n\nconst runService = async form => {\n  const abi = returnAbi(\"serviceCallback\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.serviceJobID, form.port, form.serviceDapps]);\n  const txHash = await runTrx(data); // await contract.events.ServiceRunning({}, function(error, event){\n  //     console.log(error);\n  //     console.log(event);\n  // });\n};\n\nconst setDockerImage = async form => {\n  const abi = returnAbi(\"setDockerImage\");\n  const data = web3.eth.abi.encodeFunctionCall(abi, [form.setDockerImageName, form.imageAddress, form.imageHash, form.imageType]);\n  const txHash = await runTrx(data); // await contract.events.DockerSet({}, function(error, event){\n  //     console.log(error);\n  //     console.log(event);\n  // });\n};\n\nconst runTrx = async data => {\n  const transactionParameters = {\n    nonce: '0x00',\n    gasPrice: '2000000000',\n    gasLimit: '21000',\n    to: contractAddress,\n    from: ethereum.selectedAddress,\n    value: '0x00',\n    data,\n    chainId: '0x3' // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.\n\n  };\n  return await ethereum.request({\n    method: 'eth_sendTransaction',\n    params: [transactionParameters]\n  });\n};\n\nexport default {\n  fetchJobs,\n  fetchServices,\n  postJobOrService,\n  runJob,\n  runService,\n  setDockerImage\n};","map":{"version":3,"sources":["/Users/natanaelprudhomme/Workspaces/dapp-workers/uis/jobs/src/lib/web3/index.js"],"names":["Web3","NexusJSON","jobs","services","web3","contractAddress","contract","eth","Contract","abi","ethereum","window","returnAbi","func","find","el","name","type","fetchLastJob","methods","lastJobID","call","fetchJobs","thisObject","i","job","push","setState","JSON","stringify","fetchServices","console","log","postJobOrService","form","data","encodeFunctionCall","consumer","imageName","inputFS","args","txHash","runTrx","runJob","jobID","outputFS","dapps","events","JobResult","error","event","runService","serviceJobID","port","serviceDapps","setDockerImage","setDockerImageName","imageAddress","imageHash","imageType","transactionParameters","nonce","gasPrice","gasLimit","to","from","selectedAddress","value","chainId","request","method","params"],"mappings":"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","sourcesContent":["import Web3 from 'web3';\nimport NexusJSON from '../../abi/Nexus.json';\n\nconst jobs = [];\nconst services = [];\n// const provider = new Web3.providers.WebsocketProvider('ws://localhost:8545');\n// const web3 = new Web3(provider);\nconst web3 = new Web3('http://localhost:8545');\nconst contractAddress = \"0x94D387F50569200aDACFd903345D077ef6ABcE11\";\nconst contract = new web3.eth.Contract(NexusJSON.abi,contractAddress);\nconst ethereum = window.ethereum;\n\nconst returnAbi = (func) => {\n    return NexusJSON.abi.find(el => el.name == func && el.type == \"function\");\n}\n\nconst fetchLastJob = async () => {\n    return await contract.methods.lastJobID().call();\n}\n\nconst fetchJobs = async (thisObject) => {\n    for(let i=0; i < await fetchLastJob(); i++) {\n        const job = await contract.methods.jobs(i).call();\n        jobs.push(job);\n    }\n    thisObject.setState({jobs: JSON.stringify(jobs)});\n}\n\nconst fetchServices = async (thisObject) => {\n    for(let i=0; i < await fetchLastJob(); i++) {\n        const job = await contract.methods.services(i).call();\n        services.push(job);\n    }\n    console.log(`services: ${services}`);\n    thisObject.setState({services: JSON.stringify(services)});\n}\n\nconst postJobOrService = async (form) => {\n    const abi = returnAbi(\"run\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.consumer,\n        form.imageName,\n        form.inputFS,\n        form.args\n    ]);\n\n    const txHash = await runTrx(data);\n    // await contract.events.Run({}, function(error, event){\n    //     console.log(error);\n    //     console.log(event);\n    // });\n}\n\nconst runJob = async (form) => {\n    const abi = returnAbi(\"jobCallback\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.jobID,\n        form.outputFS,\n        form.dapps\n    ]);\n\n    const txHash = await runTrx(data);\n    await contract.events.JobResult({}, function(error, event){\n        console.log(error);\n        console.log(event);\n    });\n    // await contract.events.JobDone({}, function(error, event){\n    //     console.log(error);\n    //     console.log(event);\n    // });\n}\n\nconst runService = async (form) => {\n    const abi = returnAbi(\"serviceCallback\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.serviceJobID,\n        form.port,\n        form.serviceDapps\n    ]);\n\n    const txHash = await runTrx(data);\n    // await contract.events.ServiceRunning({}, function(error, event){\n    //     console.log(error);\n    //     console.log(event);\n    // });\n}\n\nconst setDockerImage = async (form) => {\n    const abi = returnAbi(\"setDockerImage\");\n    const data = web3.eth.abi.encodeFunctionCall(abi, [\n        form.setDockerImageName,\n        form.imageAddress,\n        form.imageHash,\n        form.imageType\n    ]);\n\n    const txHash = await runTrx(data);\n    // await contract.events.DockerSet({}, function(error, event){\n    //     console.log(error);\n    //     console.log(event);\n    // });\n}\n\nconst runTrx = async (data) => {\n    const transactionParameters = {\n        nonce: '0x00',\n        gasPrice: '2000000000',\n        gasLimit: '21000',\n        to: contractAddress,\n        from: ethereum.selectedAddress,\n        value: '0x00',\n        data,\n        chainId: '0x3', // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.\n    };\n    return await ethereum.request({\n        method: 'eth_sendTransaction',\n        params: [transactionParameters],\n    });\n}\n\nexport default { \n    fetchJobs,\n    fetchServices,\n    postJobOrService,\n    runJob,\n    runService,\n    setDockerImage\n}"]},"metadata":{},"sourceType":"module"}